import { ProxyAgent, setGlobalDispatcher } from 'undici';
import { GoogleGenAI } from '@google/genai';
import * as fs from 'fs';
import * as path from 'path';
import 'dotenv/config';

// Setup proxy
const proxyUrl = process.env.HTTPS_PROXY || process.env.HTTP_PROXY;
if (proxyUrl) {
  console.log(`Using proxy: ${proxyUrl}`);
  const proxyAgent = new ProxyAgent(proxyUrl);
  setGlobalDispatcher(proxyAgent);
}

const GEMINI_API_KEY = process.env.GEMINI_API_KEY;

if (!GEMINI_API_KEY) {
  console.error('Error: GEMINI_API_KEY is not set in .env');
  process.exit(1);
}

const client = new GoogleGenAI({ apiKey: GEMINI_API_KEY });

async function waitForOperation(operation: any): Promise<void> {
  while (!operation.done) {
    console.log('  Waiting for indexing...');
    await new Promise(resolve => setTimeout(resolve, 5000));
    operation = await client.operations.get({ operation });
  }
  console.log('  Indexing complete.');
}

async function main() {
  try {
    // 1. Create File Search Store
    console.log('=== Creating File Search Store ===');
    const fileSearchStore = await client.fileSearchStores.create({
      config: { displayName: 'deepresearch-test-store' }
    });
    console.log(`Store created: ${fileSearchStore.name}`);

    // 2. Upload files to File Search Store (tech_prop.md and target.md)
    const resourceDir = path.join(process.cwd(), 'resource');
    const filesToUpload = [
      { name: 'tech_prop.md', mimeType: 'text/plain' },
      { name: 'target.md', mimeType: 'text/plain' },
    ];

    for (const file of filesToUpload) {
      const filePath = path.join(resourceDir, file.name);
      console.log(`\n=== Uploading ${file.name} ===`);

      const operation = await client.fileSearchStores.uploadToFileSearchStore({
        file: filePath,
        fileSearchStoreName: fileSearchStore.name!,
        config: {
          displayName: file.name,
          mimeType: file.mimeType,
        }
      });

      await waitForOperation(operation);
    }

    // 3. Read prompt from prompt.md
    const promptPath = path.join(resourceDir, 'prompt.md');
    const promptContent = fs.readFileSync(promptPath, 'utf-8');
    console.log('\n=== Prompt loaded from prompt.md ===');
    console.log(`Prompt length: ${promptContent.length} chars`);

    // 4. Start Deep Research with File Search
    console.log('\n=== Starting Deep Research ===');
    const stream = await client.interactions.create({
      input: promptContent,
      agent: 'deep-research-pro-preview-12-2025',
      background: true,
      stream: true,
      tools: [
        {
          type: 'file_search',
          file_search_store_names: [fileSearchStore.name!]
        }
      ],
      agent_config: {
        type: 'deep-research',
        thinking_summaries: 'auto'
      }
    } as any);

    let interactionId: string | undefined;
    let lastEventId: string | undefined;

    console.log('\n=== Research Output ===\n');

    for await (const chunk of stream as AsyncIterable<any>) {
      // Debug: show all event types
      console.log(`[Event: ${chunk.event_type}]`);

      // Capture Interaction ID
      if (chunk.event_type === 'interaction.start') {
        interactionId = chunk.interaction?.id;
        console.log(`[Interaction started: ${interactionId}]\n`);
      }

      // Track Event ID for potential reconnection
      if (chunk.event_id) {
        lastEventId = chunk.event_id;
      }

      // Handle Content
      if (chunk.event_type === 'content.delta') {
        if (chunk.delta?.type === 'text') {
          process.stdout.write(chunk.delta.text);
        } else if (chunk.delta?.type === 'thought_summary') {
          console.log(`\n[Thought]: ${chunk.delta.content?.text}\n`);
        } else {
          console.log(`[Delta type: ${chunk.delta?.type}]`);
        }
      } else if (chunk.event_type === 'interaction.complete') {
        console.log('\n\n=== Research Complete ===');
        // Show final outputs
        if (chunk.interaction?.outputs) {
          console.log('\n=== Final Outputs ===');
          for (const output of chunk.interaction.outputs) {
            console.log(output.text || JSON.stringify(output));
          }
        }
      }
    }

    // 5. Cleanup - Delete the File Search Store
    console.log('\n=== Cleaning up ===');
    await client.fileSearchStores.delete({
      name: fileSearchStore.name!,
      config: { force: true }
    });
    console.log('File Search Store deleted.');

  } catch (error) {
    console.error('Error:', error);
    process.exit(1);
  }
}

main();
