import { GoogleGenAI } from '@google/genai';
import * as path from 'path';

// APIキーの準備 (環境変数などで管理推奨)
const apiKey = process.env.GEMINI_API_KEY |

| 'YOUR_API_KEY';
const client = new GoogleGenAI({ apiKey });

// 使用するエージェントID (2025年12月時点のプレビュー版)
const DEEP_RESEARCH_AGENT = 'deep-research-pro-preview-12-2025';

/**
 * 処理の待機用ユーティリティ
 */
const sleep = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

async function main() {
  try {
    console.log("=== 1. 社内資産データのアップロード開始 ===");

    // 1-1. File Search Store (RAG用のデータ格納庫) の作成
    const storeOperation = await client.fileSearchStores.create({
      config: { displayName: 'Company_Assets_Store' }
    });
    console.log(`Store created: ${storeOperation.name}`);

    // 1-2. ファイルのアップロード (例: 技術資産リスト.pdf)
    // 実際にはローカルのファイルパスを指定してください
    const filePath = path.resolve(__dirname, 'tech_assets.pdf');
    const uploadResult = await client.files.upload({
      file: filePath,
      config: { displayName: 'Technical Assets List' }
    });
    console.log(`File uploaded: ${uploadResult.name}`);

    // 1-3. アップロードしたファイルをStoreにインポート
    // ※Deep Researchが参照できるようにStoreへ関連付けます
    let importOp = await client.fileSearchStores.importFile({
      fileSearchStoreName: storeOperation.name,
      fileName: uploadResult.name
    });

    // インポート完了待ち (ポーリング)
    console.log("Waiting for file indexing...");
    while (true) {
      // 完了確認 (operationのステータスチェック方法はSDKのバージョンにより微差あり)
      // 簡易的に数秒待機して完了とみなす、もしくはoperations.getで確認する
      // ここでは簡略化のため待機のみ行いますが、本番ではoperation.doneを確認します
      await sleep(5000); 
      // ※厳密な実装では client.operations.get({ name: importOp.name }) 等でステータスを確認
      break; 
    }

    console.log("=== 2. Deep Research エージェントの起動 ===");

    // 2. Interactions API でリサーチタスクを作成
    const researchPrompt = `
      当社の「技術資産リスト」を分析し、現在の市場トレンドと照らし合わせて
      これまで検討されていない新しい事業仮説を3つ提案してください。
      
      条件:
      1. 技術的な実現可能性が高いこと
      2. 2026年以降の成長市場であること
      3. 競合他社がまだ参入していないニッチ領域であること
    `;

    const interaction = await client.interactions.create({
      agent: DEEP_RESEARCH_AGENT,
      input: researchPrompt,
      background: true, // Deep Researchは時間がかかるため必須
      tools:
        }
      ]
    });

    console.log(`Research Task Started. Interaction ID: ${interaction.id}`);
    console.log("Running research (this may take 10-20 minutes)...");

    // === 3. 完了までポーリング ===
    while (true) {
      // 現在のステータスを取得
      const currentStatus = await client.interactions.get({
        name: interaction.name! // または interaction.id
      });

      const status = currentStatus.status;
      console.log(`Current Status: ${status}`);

      if (status === 'COMPLETED') {
        console.log("\n=== Research Completed! ===");
        // 最終的なレポートを出力
        // outputs配列の最後の要素に最終回答が含まれることが多い
        const finalOutput = currentStatus.outputs?.;
        console.log(finalOutput?.text);
        break;
      } else if (status === 'FAILED') {
        console.error("Research Failed:", currentStatus.error);
        break;
      }

      // 30秒ごとに確認
      await sleep(30000);
    }

  } catch (error) {
    console.error("Error executing Deep Research:", error);
  }
}

main();