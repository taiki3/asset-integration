# 実装詳細指示書：Deep Researchエージェントと評価パイプラインの構築

これまでの要件に基づき、アプリケーションの中核となる「Step 2：Deep Research機能」およびそれに続く「Step 3〜5：評価・統合パイプライン」のバックエンドロジックを実装してください。

## 1. AIモデル設定 (Configuration) 本アプリケーションでは、タスクの性質に応じて以下の2つの最新モデルを使い分ける「ハイブリッド戦略」を採用してください。

High-Reasoning Model: gemini-3.0-pro-preview

用途: 複雑な論理構築、長文レポートの執筆、深い評価（Deep Researchの執筆、Step 3, 4）。

High-Speed Model: gemini-3.0-flash-preview

用途: 計画立案、データ抽出、単純な判定、リスト化（Deep Researchの計画・確認、Step 5）。

## 2. システムプロンプトの扱い

各ステップ（Step 2, 3, 4, 5）で使用するシステムプロンプト（System Instructions）は、別途定義済みの定数テキストとしてコード内に組み込んでください。

ファイル読み込み処理は不要です。各処理を実行する際、対応するプロンプト文字列をAPIリクエストに含めてください。

## 3. Step 2: Deep Research エージェントの実装

Step 2（事業仮説の生成）は単なるAPIコールではなく、以下の4フェーズを循環する自律型エージェントとして実装してください。

前提: gemini-3.0-flash-preview および gemini-3.0-pro-preview の両方で、Google Search Grounding (tools='google_search_retrieval') を有効化すること。

【実行フロー】

Phase 1: Planning (Model: Flash)

入力された「ターゲット指定」と「技術資産」を分析し、調査すべき論点と検索クエリリスト（5〜10個）を生成します。

Phase 2: Exploring (Model: Flash + Search Tool)

Phase 1のクエリに基づき、並列的にWeb検索を実行します。

Phase 3: Reasoning & Iteration (Model: Flash)

「現在の検索結果で、Step 2のプロンプトが求めるレポート要件（5つの仮説、トレードオフ、メカニズム等）を十分に満たせるか？」を判定します。

不足がある場合: 不足情報を補うクエリを生成し、Phase 2に戻って追加検索を行います。

ループ制限: このサイクルは最大3回までとし、それ以降はPhase 4へ強制移行します。

Phase 4: Synthesizing (Model: Pro)

重要: ここで初めて、**「Step 2用のシステムプロンプト」**を使用します。

収集した全情報（Context）と入力アセットを入力し、最終的な事業仮説レポートを執筆させます。

Override指示: プロンプト内に「リサーチ計画の承認を待て」等の対話的な指示が含まれていても無視し、一回でレポートを出力させる追加指示をAPIリクエスト時に付与してください。

【品質保証プロセス (Post-Process: Validation)】

Extraction (Model: Flash):

生成されたレポートから、各仮説について以下の4要素をJSON形式で抽出します。

仮説タイトル

解決する物理的矛盾 (Trade-off)

メカニズム (S-P-P連結)

競争優位性 (Moat)

Check Logic (Python):

以下の条件を機械的に判定し、結果をログまたはDBに保存してください。

len(hypotheses) == 5 であること。

各仮説において、上記4つのキー（特に Moat）に空文字でない値が入っていること。

## 4. Step 3 & 4: 評価プロセスの実装

Step 2の出力を用いて、連続的に評価を実行します。深い推論が必要なため、Proモデルを使用してください。

Step 3 (科学評価):

Model: gemini-3.0-pro-preview

Input: 「技術資産リスト」 + 「Step 2のレポート全文」

System Prompt: **「Step 3用のシステムプロンプト」**を使用。

Output: 評価レポートテキスト（DBに保存）

Step 4 (戦略監査):

Model: gemini-3.0-pro-preview

Input: 「技術資産リスト」 + 「Step 2のレポート」 + 「Step 3のレポート」

System Prompt: **「Step 4用のシステムプロンプト」**を使用。

Output: 監査レポートテキスト（DBに保存）

## 5. Step 5: 統合リストの生成

Step 5 (統合):

Model: gemini-3.0-flash-preview (高速処理のため)

Input: Step 2, 3, 4 の全テキストデータ

System Prompt: **「Step 5用のシステムプロンプト」**を使用。

Output: TSV形式の構造化データ

処理: 出力されたTSVをパースし、アプリケーションのデータベース（またはダウンロード用ファイル）として保存してください。